<!DOCTYPE html>
<html lang="zxx">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Email Verification" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BOOKBAZAAR</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <!-- SweetAlert -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body class="d-flex align-items-center justify-content-center vh-100 bg-light">

  <div class="card shadow-sm" style="max-width: 400px; width: 100%;">
    <div class="card-body">
      <h3 class="text-center mb-4">Email Verification Page</h3>

      <form id="otpForm" action="/verify-otp" method="post" onsubmit="return validateOTPform()">
        <div class="mb-3">
          <label for="otp" class="form-label">Enter OTP:</label>
          <input type="text" id="otp" name="otp" class="form-control" required maxlength="6" pattern="\d*" />
        </div>

        <button type="submit" class="btn btn-primary w-100">Verify Email</button>

        <div class="text-center mt-3">
          <div id="otpTimer" class="d-inline-flex justify-content-center align-items-center rounded-circle border bg-light" style="width:60px; height:60px;">
            <span id="timerValue" class="fw-bold fs-4">60</span>
          </div>
          <button type="button" class="btn btn-secondary w-100 mt-2" onclick="resendOTP()">Resend OTP</button>
        </div>

        <% if (locals.message && message.length > 0) { %>
          <div class="alert alert-danger text-center mt-3"><%= message %></div>
        <% } %>
      </form>

      <div class="text-center mt-4">
        <small class="text-muted">Already verified? <a href="/login">Login now</a></small>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.getElementById("otp").focus();

    let timer = 60;
    let timerInterval;

    function startTimer() {
      timerInterval = setInterval(() => {
        timer--;
        document.getElementById("timerValue").textContent = timer;
        if (timer <= 0) {
          clearInterval(timerInterval);
          const timerValue = document.getElementById("timerValue");
          timerValue.classList.add("text-danger", "fs-6");
          timerValue.textContent = "Expired";
          document.getElementById("otp").disabled = true;
        }
      }, 1000);
    }
    startTimer();

    function validateOTPform(){
      const otpInput = document.getElementById('otp').value;
      $.ajax({
        type:'POST',
        url:'verify-otp',
        data:{otp:otpInput},
        success:function(response){
          if(response.success){
            Swal.fire({
              icon:'success',
              title:'OTP verified successfully',
              showConfirmButton:false,
              timer:1500,
            }).then(()=>{ window.location.href = response.redirectUrl; })
          }else {
            Swal.fire({
              icon:'error',
              title:'Error',
              text:response.message,
            })
          }
        },
        error: function(){
          Swal.fire({
            icon:'error',
            title:'Invalid OTP',
            text:'Please try again'
          })
        }
      })
      return false;
    }

    function resendOTP(){
      clearInterval(timerInterval);
      timer=60;
      document.getElementById("otp").disabled=false;
      const timerValue = document.getElementById('timerValue');
      timerValue.classList.remove("text-danger", "fs-6");
      timerValue.classList.add("fw-bold","fs-4");
      timerValue.textContent = "60";
      startTimer();

      $.ajax({
        type:'POST',
        url:"/resend-otp",
        success:function(response){
          if(response.success){
            Swal.fire({
              icon:"success",
              title:'OTP Resent Successfully',
              showConfirmButton:false,
              timer:1500,
            })
          }else {
            Swal.fire({
              icon:'error',
              title:'Error',
              text:'An error occurred while resending OTP. Try again',
            })
          }
        }
      })
      return false;
    }
  </script>
</body>
</html>
