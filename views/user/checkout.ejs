<%- include("../partials/user/header.ejs", { active: 'cart', user: user, cartCount: cartCount }) %>

<div class="container my-5">
  <div class="row">
    <!-- Left column: addresses & payment -->
    <div class="col-lg-7">
      <h4 class="mb-4">Billing Details</h4>

      <!-- Delivery Address -->
      <div class="card mb-4">
        <div class="card-body">
          <h6 class="card-title">Delivery Address</h6>
          <hr>
          <form id="checkoutForm" action="/checkout" method="POST">
            <input type="hidden" name="addressId" id="addressId" value="">
            <div class="mb-3">
              <% if (user && Array.isArray(user.addresses) && user.addresses.length) { %>
                <% user.addresses.forEach(function(addr, idx) { %>
                  <div class="border rounded p-3 mb-3 d-flex justify-content-between align-items-center">
                    <div>
                      <strong><%= addr.name %></strong>
                      <div class="small text-muted"><%= addr.line1 %> <%= addr.line2 ? ', ' + addr.line2 : '' %></div>
                      <div class="small text-muted"><%= addr.city %> <%= addr.postalCode ? '- ' + addr.postalCode : '' %></div>
                      <div class="small text-muted"><%= addr.state %> <%= addr.country ? ', ' + addr.country : '' %></div>
                      <div class="small text-muted">Contact : <%= addr.phone %></div>
                    </div>
                    <div class="text-end">
                      <div class="form-check">
                        <input class="form-check-input address-radio" type="radio" name="addressRadio" id="addr_<%= idx %>"
                               value="<%= addr._id %>" <%= addr.isPrimary ? 'checked' : '' %> >
                        <label class="form-check-label small" for="addr_<%= idx %>">
                          Select
                        </label>
                      </div>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <div class="alert alert-warning">You don't have any saved addresses. <a href="/addresses/new">Add one</a></div>
              <% } %>
            </div>



            <div class="mb-4">
  <!-- address modal  -->
  <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addAddressModal">
    Add New Address
  </button>
</div>



            <!-- Payment Methods -->
            <div class="mb-4">
              <h6>Payment Methods</h6>
              <hr>
              <p class="text-muted small">Select any payment methods</p>

              <div class="mb-2">
                <div class="form-check">
                  <input class="form-check-input payment-radio" type="radio" name="paymentMethod" id="pm_card" value="card" checked>
                  <label class="form-check-label" for="pm_card">Debit Card / Credit Card</label>
                </div>
              </div>

              <div class="mb-2">
                <div class="form-check">
                  <input class="form-check-input payment-radio" type="radio" name="paymentMethod" id="pm_bank" value="bank">
                  <label class="form-check-label" for="pm_bank">Bank</label>
                </div>
              </div>

              <div class="mb-2">
                <div class="form-check">
                  <input class="form-check-input payment-radio" type="radio" name="paymentMethod" id="pm_upi" value="upi">
                  <label class="form-check-label" for="pm_upi">UPI Method</label>
                </div>
              </div>

              <div class="mb-2">
                <div class="form-check">
                  <input class="form-check-input payment-radio" type="radio" name="paymentMethod" id="pm_cod" value="cod">
                  <label class="form-check-label" for="pm_cod">Cash on delivery</label>
                </div>
              </div>
            </div>

          <!-- Hidden submit lives outside address block for layout -->
        </div>
      </div>

    </div>

    <!-- Right column: order summary -->
    <div class="col-lg-5">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Your Order</h6>
          <hr>

          <% 
            let subtotal = 0;
            if (cart && Array.isArray(cart.items)) {
              cart.items.forEach(function(it) {
                subtotal += (Number(it.priceAtAdd || 0) * Number(it.qty || 0));
              });
            }
          %>

          <div class="list-group mb-3">
            <% if (cart && cart.items && cart.items.length) { %>
              <% cart.items.forEach(function(it) { %>
                <div class="list-group-item border-0 px-0">
                  <div class="d-flex gap-3">
                    <div style="width:64px; height:64px; flex:0 0 64px;">
                      <% if (it.image) { %>
                        <img src="<%= it.image %>" alt="<%= it.title %>" class="img-fluid rounded" style="width:64px;height:64px;object-fit:cover;">
                      <% } else { %>
                        <div class="bg-light rounded w-100 h-100 d-flex align-items-center justify-content-center small text-muted">No Image</div>
                      <% } %>
                    </div>
                    <div class="flex-grow-1">
                      <div class="fw-semibold"><%= it.title || 'Untitled' %></div>
                      <div class="small text-muted">Qty: <%= it.qty %></div>
                    </div>
                    <div class="text-end">
                      <div>₹<%= (Number(it.priceAtAdd || 0)).toFixed(2) %></div>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="list-group-item border-0 px-0">Your cart is empty.</div>
            <% } %>
          </div>

          <div class="d-flex justify-content-between">
            <div class="small text-muted">Subtotal:</div>
            <div>₹<%= subtotal.toFixed(2) %></div>
          </div>
          <div class="d-flex justify-content-between">
            <div class="small text-muted">Shipping:</div>
            <div class="small text-muted">Free</div>
          </div>
          <hr>
          <div class="d-flex justify-content-between fw-bold">
            <div>Total:</div>
            <div>₹<%= subtotal.toFixed(2) %></div>
          </div>

          <div class="mt-3">
            <div class="input-group mb-3">
              <input type="text" name="coupon" class="form-control" placeholder="Coupon Code">
              <button class="btn btn-outline-secondary" type="button">Apply Coupon</button>
            </div>
            <!-- place order button triggers form submit -->
            <button type="submit" form="checkoutForm" class="btn btn-dark w-100">Place Order</button>
          </div>

        </div>
      </div>
    </div>
  </div> <!-- row -->
</div>

</form>


<!-- Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="modalAddAddressForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Name</label>
              <input name="name" id="m_name" type="text" class="form-control form-control-lg" placeholder="Recipient Name" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Email</label>
              <input name="email" id="m_email" type="email" class="form-control form-control-lg" placeholder="example@gmail.com">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone</label>
              <input name="phone" id="m_phone" type="tel" class="form-control form-control-lg" placeholder="+91 12345 67890">
            </div>

            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea name="line1" id="m_line1" rows="3" class="form-control form-control-lg" placeholder="House Name, House Number, Locality" required></textarea>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">District / Town</label>
              <input name="city" id="m_city" type="text" class="form-control" placeholder="eg : Ernakulam" >
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">State</label>
              <input name="state" id="m_state" type="text" class="form-control" placeholder="eg : Kerala" >
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Landmark (optional)</label>
              <input name="line2" id="m_line2" type="text" class="form-control" placeholder="eg : Hospital">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Pin Code</label>
              <input name="postalCode" id="m_postalCode" type="text" pattern="\d{6}" class="form-control" placeholder="eg : 689230" >
            </div>

            <div class="col-12">
              <label class="form-label d-block">Address Type</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="label" id="m_addrHome" value="Home" checked>
                <label class="form-check-label" for="m_addrHome">Home</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="label" id="m_addrWork" value="Work">
                <label class="form-check-label" for="m_addrWork">Work</label>
              </div>
            </div>

            <div class="col-12">
              <input type="hidden" name="isPrimary" value="false">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="m_isPrimary" name="isPrimary" value="true">
                <label class="form-check-label" for="m_isPrimary">Set as primary address</label>
              </div>
            </div>

          </div> <!-- row -->
        </div> <!-- modal-body -->

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="modalSaveAddressBtn" class="btn btn-dark">Save Address</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  (function () {
    
    const addressIdField = document.getElementById('addressId');

    
    const modalForm = document.getElementById('modalAddAddressForm');
    modalForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      
      if (!modalForm.checkValidity()) {
        modalForm.classList.add('was-validated');
        return;
      }

      const formData = new FormData(modalForm);
      
      const payload = {
        label: formData.get('label') || 'Home',
        name: (formData.get('name') || '').trim(),
        email: (formData.get('email') || '').trim(),
        phone: (formData.get('phone') || '').trim(),
        line1: (formData.get('line1') || '').trim(),
        line2: (formData.get('line2') || '').trim(),
        city: (formData.get('city') || '').trim(),
        state: (formData.get('state') || '').trim(),
        postalCode: (formData.get('postalCode') || '').trim(),
        country: 'India',
        isPrimary: formData.get('isPrimary') === 'true'
      };

     
      const saveBtn = document.getElementById('modalSaveAddressBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const res = await fetch('/checkout/address/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({message:'Server error'}));
          throw new Error(err.message || 'Failed to save address');
        }

        const newAddr = await res.json();

        
        const container = document.querySelector('#checkoutForm .mb-3'); 
        if (container) {
          const idx = container.querySelectorAll('.border.rounded.p-3').length;
          const wrapper = document.createElement('div');
          wrapper.className = 'border rounded p-3 mb-3 d-flex justify-content-between align-items-center';
          wrapper.innerHTML = `
            <div>
              <strong>${escapeHtml(newAddr.name)}</strong>
              <div class="small text-muted">${escapeHtml(newAddr.line1)}${newAddr.line2 ? ', ' + escapeHtml(newAddr.line2) : ''}</div>
              <div class="small text-muted">${escapeHtml(newAddr.city)} ${newAddr.postalCode ? '- ' + escapeHtml(newAddr.postalCode) : ''}</div>
              <div class="small text-muted">${escapeHtml(newAddr.state)}${newAddr.country ? ', ' + escapeHtml(newAddr.country) : ''}</div>
              <div class="small text-muted">Contact : ${escapeHtml(newAddr.phone)}</div>
            </div>
            <div class="text-end">
              <div class="form-check">
                <input class="form-check-input address-radio" type="radio" name="addressRadio" id="addr_${idx}"
                      value="${newAddr._id}" ${newAddr.isPrimary ? 'checked' : ''}>
                <label class="form-check-label small" for="addr_${idx}">Select</label>
              </div>
            </div>
          `;
          container.insertBefore(wrapper, container.firstChild);
        }

        
        if (addressIdField) addressIdField.value = newAddr._id;

        
        const modalEl = document.getElementById('addAddressModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        
        modalForm.reset();
        modalForm.classList.remove('was-validated');

      } catch (err) {
        alert('Could not save address: ' + err.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Address';
      }
    });

   
    document.addEventListener('change', function (e) {
      if (e.target && e.target.classList.contains('address-radio')) {
        document.getElementById('addressId').value = e.target.value;
      }
    });

    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, function (m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }
  })();
</script>

<script>
 
  function setInitialAddressField() {
    const checked = document.querySelector('.address-radio:checked');
    if (checked) {
      document.getElementById('addressId').value = checked.value;
    }
  }


  document.addEventListener('change', function(e) {
    if (e.target && e.target.classList.contains('address-radio')) {
      document.getElementById('addressId').value = e.target.value;
    }
  });

  
  document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    const addr = document.getElementById('addressId').value;
    if (!addr) {
      e.preventDefault();
      alert('Please select or add a delivery address before placing order.');
      return false;
    }
    
    return true;
  });

  
  setInitialAddressField();
</script>

<%- include("../partials/user/footer.ejs") %>
