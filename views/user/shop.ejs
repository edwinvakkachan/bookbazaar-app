<%- include("../partials/user/header.ejs") %>

<div class="main-container">
  <section class="shop-page container">
    <div class="row">
      <!-- Sidebar Filters -->
      <aside class="col-md-3">
        <div class="filter-box border p-3 rounded">
          <h5 class="fw-bold">Filters</h5>
          <hr>

          <!-- Category Filter -->
          <div class="mb-3">
            <h6 class="d-flex justify-content-between align-items-center">
              Categories
            </h6>
            <% for (let i = 0; i < category.length; i++) { %>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="cat-<%= category[i]._id %>"
                       onclick="applyFilter('category','<%= category[i]._id %>')"
                       <%= (query.category && query.category.split(',').includes(category[i]._id.toString()))
                            ? 'checked' : '' %> >
                <label class="form-check-label" for="cat-<%= category[i]._id %>">
                  <%= category[i].name %>
                </label>
              </div>
            <% } %>
          </div>

          <!-- Brand Filter -->
          <div class="mb-3">
            <h6>Brands</h6>
            <% for (let i = 0; i < brand.length; i++) { %>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="brand-<%= brand[i]._id %>"
                       onclick="applyFilter('brand','<%= brand[i]._id %>')"
                       <%= (query.brand && query.brand.split(',').includes(brand[i]._id.toString()))
                            ? 'checked' : '' %> >
                <label class="form-check-label" for="brand-<%= brand[i]._id %>">
                  <%= brand[i].brandName %>
                </label>
              </div>
            <% } %>
          </div>

          <!-- Price Filter -->
          <div class="mb-3">
            <h6>Price</h6>
            <div class="d-flex flex-column gap-2">
              <button type="button" class="btn btn-outline-dark <%= query.price === 'under100' ? 'active' : '' %>"
                      onclick="applyFilter('price','under100')">Under â‚¹100</button>

              <button type="button" class="btn btn-outline-dark <%= query.price === '100-250' ? 'active' : '' %>"
                      onclick="applyFilter('price','100-250')">â‚¹100 - â‚¹250</button>

              <button type="button" class="btn btn-outline-dark <%= query.price === '250-500' ? 'active' : '' %>"
                      onclick="applyFilter('price','250-500')">â‚¹250 - â‚¹500</button>

              <button type="button" class="btn btn-outline-dark <%= query.price === 'above500' ? 'active' : '' %>"
                      onclick="applyFilter('price','above500')">Above â‚¹500</button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Products + Sorting -->
      <main class="col-md-9">
        <!-- Sort bar -->
        <div class="d-flex justify-content-end mb-3">
          <ul class="nav nav-pills">
            <li class="nav-item">
              <a class="nav-link <%= sort === 'popularity' ? 'active' : '' %>"
                 href="javascript:void(0)" onclick="applySort('popularity')">Popularity</a>
            </li>
            <li class="nav-item">
              <a class="nav-link <%= sort === 'newest' ? 'active' : '' %>"
                 href="javascript:void(0)" onclick="applySort('newest')">Newest First</a>
            </li>
            <li class="nav-item">
              <a class="nav-link <%= sort === 'priceAsc' ? 'active' : '' %>"
                 href="javascript:void(0)" onclick="applySort('priceAsc')">Price Low - High</a>
            </li>
            <li class="nav-item">
              <a class="nav-link <%= sort === 'priceDesc' ? 'active' : '' %>"
                 href="javascript:void(0)" onclick="applySort('priceDesc')">Price High - Low</a>
            </li>
            <li class="nav-item">
              <a class="nav-link <%= !sort ? 'active' : '' %>"
                 href="javascript:void(0)" onclick="applySort('')">Default</a>
            </li>
          </ul>
        </div>

        <!-- Product Grid -->
        <div class="row">
          <% for (let i = 0; i < products.length; i++) { %>
            <div class="col-md-4 mb-4">
              <div class="card h-100">
  <!-- Wishlist button top-right -->
  <div class="position-absolute top-0 end-0 p-2">
    <form action="/wishlist/add" method="POST">
      <input type="hidden" name="productId" value="<%= products[i]._id %>">
      <!-- <button type="submit" class="btn btn-sm btn-outline-dark" title="Add to Wishlist">ðŸ–¤</button> -->
    <button type="submit" class="btn btn-sm btn-dark" title="Add to Wishlist">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16">
    <path d="M8 2.748-.717 5.932C.281 3.493 3.005.399 8 5.748 12.995.399 15.719 3.493 14.717 5.932L8 15l-6.717-9.068z"/>
  </svg>
</button>
    </form>
  </div>
                <img src="<%= products[i].productImage[0] %>" class="card-img-top" alt="<%= products[i].productName %>">
                <div class="card-body">
                  <h6 class="card-title"><%= products[i].productName %></h6>
                  <p class="mb-1">Brand: <%= products[i].brand?.brandName || "N/A" %></p>
                  <p>â‚¹<%= products[i].salePrice %>
                    <span class="text-muted"><strike>â‚¹<%= products[i].regularPrice %></strike></span>
                  </p>
                  <div class="d-flex justify-content-between">
                    <a href="/book/<%= products[i]._id %>" class="btn btn-sm btn-outline-dark">View Details</a>
                    
                    
                    
                    <form onsubmit="event.preventDefault(); addToCart('<%= products[i]._id %>');">
  <button type="submit" class="btn btn-sm btn-dark">Add to Cart</button>
</form>



                  </div>
                </div>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <div class="pagination mt-4">
          <% if (currentPage > 1) { %>
            <a class="btn btn-outline-dark" href="javascript:void(0)" onclick="goToPage(<%= currentPage - 1 %>)">Prev</a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <a class="btn <%= currentPage === i ? 'btn-dark' : 'btn-outline-dark' %>"
               href="javascript:void(0)" onclick="goToPage(<%= i %>)"><%= i %></a>
          <% } %>

          <% if (currentPage < totalPages) { %>
            <a class="btn btn-outline-dark" href="javascript:void(0)" onclick="goToPage(<%= currentPage + 1 %>)">Next</a>
          <% } %>
        </div>
      </main>
    </div>
  </section>
</div>

<!-- Popup Modal -->
<div class="modal fade" id="popupAlert" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="popupAlertTitle">Notification</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="popupAlertMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>



<script>
  function applyFilter(type, value) {
    const params = new URLSearchParams(window.location.search);

    
    if (type !== 'price') {
      let current = params.get(type) ? params.get(type).split(",") : [];

      if (current.includes(value)) {
        current = current.filter(v => v !== value); 
      } else {
        current.push(value); 
      }

      if (current.length > 0) {
        params.set(type, current.join(","));
      } else {
        params.delete(type);
      }
    } else {
     
      const currentPrice = params.get('price');
      if (currentPrice === value) {
        
        params.delete('price');
      } else {
       
        params.set('price', value);
      }
    }

    
    params.set('page', 1);

   
    window.location.href = '/shop?' + params.toString();
  }

  
  function applySort(value) {
    const params = new URLSearchParams(window.location.search);
    if (value) {
      params.set('sort', value);
    } else {
      params.delete('sort');
    }
    params.set('page', 1);
    window.location.href = '/shop?' + params.toString();
  }

  function goToPage(pageNumber) {
    const params = new URLSearchParams(window.location.search);
    params.set('page', pageNumber);
    window.location.href = '/shop?' + params.toString();
  }

  


function showPopupAlert(message, title = "Notification") {
   
    document.getElementById("popupAlertTitle").innerText = title;
    document.getElementById("popupAlertMessage").innerText = message;

    
    const myModal = new bootstrap.Modal(document.getElementById("popupAlert"));
    myModal.show();
  }

  function addToCart(productId) {
    fetch(`/cart/${productId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ productId })
    }).then(res => {
      if (res.ok) {
        showPopupAlert('âœ… Added to cart successfully.', 'Success');
      } else {
        showPopupAlert('âŒ Failed to add to cart.', 'Error');
      }
    }).catch(() => {
      showPopupAlert(' Something went wrong.', 'Warning');
    });
  }



</script>



<%- include("../partials/user/footer.ejs") %>
